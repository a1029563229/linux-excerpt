# Linux 磁盘与文件系统管理
## 磁盘组成与分区的复习
### 磁盘的组成
+ 圆形的碟片（主要记录数据的部分）；
+ 机械手臂，与在机械手臂上的磁头（可擦写碟片上的数据）；
+ 主轴马达，可以转动碟片，让机械手臂的磁头在碟片上读写数据；
### 碟片的物理组成
+ 扇区（Sector）为最小的物理存储单位，且依据磁盘设计的不同，目前主要有 512B 与 4KB 两种格式；
+ 将扇区组成一个圆，那就是柱面（Cylinder）；
+ 早期的分区主要以柱面为最小分区单位，现在的分区通常使用扇区为最小分区单位（每个扇区都有其号码，就像是座位一样）；
+ 磁盘分区表主要由两种格式，一种是限制较多的 MBR 分区表，一种是较新且限制较少的 GPT 分区表；
+ MBR 分区表中，第一个扇区最重要，里面有：主引导记录（Master boot record, MBR）及分区表（partition table），其中 MBR 占有 446B，而分区表则占有 64B；
+ GPT 分区表除了分区数量扩充较多之外，支持的磁盘容量也可以超过 2TB；
### 物理磁盘与虚拟磁盘
+ /dev/sd[a-p][1-128]: 为物理磁盘的文件名
+ /dev/vd[a-d][1-128]: 为虚拟磁盘的文件名

## 文件系统特性
+ Windows 2000 以后的版本有所谓的 NTFS 文件系统，至于 Linux 的正统文件系统则为 ext2。
### 存储区块
+ 超级区块：记录此文件系统的整体信息，包括 inode 与数据区块的总量、使用量、剩余量，以及文件系统的格式与相关信息等；
+ inode：记录文件的属性，一个文件占用一个 inode, 同时记录此文件的数据所在的区块号码；
+ 数据区块：实际记录文件的内容，若文件太大时，会占用多个区块。
### Tips
+ 在读取文件时，文件系统先格式化出 inode 与数据区块，然后操作系统根据 inode 记录的区块号码来排列磁盘的读取顺序，可以一口气将多个区块内容读出来，这种数据存取的方法我们成为索引式文件系统。
+ U 盘使用的文件系统一般为 FAT 格式，FAT 格式的文件系统并没有 inode 存在，所以没有办法一口气知道多个区块的号码，它要一个一个地将区块读出后，才会知道下一个区块在何处。如果同一个文件数据写入的区块太分散，则我们的磁头将无法在磁盘转一圈就读到所有的数据，因此磁盘就会多转好几圈才能完整地读取到这个文件的内容。
+ 碎片整理：由于文件写入的区块太过离散，此时文件读取的性能将会变得很差所致。这个时候可以通过碎片整理将同一个文件所属的区块集合在一起，这样数据的读取会比较容易。（ext2 是索引式文件系统，基本上不太需要进行碎片整理）

## Linux 的 ext2 文件系统（inode）
+ 文件系统一开始就将 inode 与数据区块规划好了，除非重新格式化（或利用 resize2fs 等命令修改其大小），否则 inode 与数据区块固定后就不再变动。
+ ext2 文件系统格式化的时候基本上是区分为多个区块群组（block group），每个区块群组都有独立的 inode、数据区块、超级区块系统。

## 区块群组（block group）的主要内容
+ 数据区块
  + 数据区块是用来放置文件数据的地方，在 ext2 文件系统中所支持的区块大小有 1K、2K 及 4K 三种。
  + ext2 文件系统的区块限制
    + 原则上，区块的大小与数量在格式化完就不能够再修改（除非重新格式化）；
    + 每个区块内最多只能够放置一个文件的数据；
    + 承上，如果文件大于区块的大小，则一个文件会占用多个区块数量；
    + 承上，若文件小于区块，则该区块的剩余容量就不能够再被使用了（磁盘空间会浪费）。
+ inode table（inode 表）
  + inode 记录的数据
    + 该文件的读写属性（write、read、excute）；
    + 该文件的拥有者和用户组（owner、group）；
    + 该文件的大小；
    + 该文件建立或状态改变的时间（ctime）；
    + 最后一次的读取时间（atime）；
    + 最近修改的时间（mtime）；
    + 定义文件特性的标识（flag），如 SetUID；
    + 该文件真正内容的指向（pointer）；
  + inode 的特色
    + 每个 inode 大小均固定为 128B（新的 ext4 与 xfs 可设置到 256B）；
    + 每个文件都仅会占用一个 inode 而已；
    + 承上，因此文件系统能够建立的文件数量与 inode 的数量有关；
    + 系统读取文件时需要先找到 inode，并分析 inode 所记录的权限与用户是否符合，若符合才能够读取区块的内容；
  + 系统将 inode 记录区块号码的区域定义为 12个直接、一个间接、一个双间接与一个三间接记录区。（间接就是再拿一个区块来当做记录区块号码的记录区，如果文件太大，就会使用间接的区块来记录编号。）
  + 直接、间接、双间接、三间接相加，得到 12 + 256 + 256*256 + 256*256*256（K）= 16GB；当文件系统将区块格式化为 1K 大小时，能够容纳的最大文件为 16GB，与文件线指标的结果是一致的。（此方法不能用在 2K 及 4K 区块大小的计算中，因为大于 2K 的区块将会受到 ext2 文件系统本身的限制，所以计算的结果会不太符合。）